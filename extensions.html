<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extensions Marketplace | Plotune</title>
    <link rel="icon" href="assets/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto+Mono:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="extension_styles.css">
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container header-container">
            <div class="logo">
                <img src="assets/logo.png" alt="Plotune Logo">
                <h1>Plotune</h1>
            </div>
            <nav>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="extensions.html" class="active">Extensions</a></li>
                    <li><a href="docs.html">Docs</a></li>
                    <li><a href="download.html">Download</a></li>
                </ul>
                <button class="mobile-menu-btn">
                    <i class="fas fa-bars"></i>
                </button>
            </nav>
        </div>
    </header>

    <!-- Marketplace Hero -->
    <section class="marketplace-hero">
        <div class="container">
            <h1>Extensions Marketplace</h1>
            <p>Enhance your Plotune experience with powerful extensions. Add new capabilities, connect to more data sources, and customize your workflow.</p>
        </div>
    </section>

    <!-- Marketplace Controls -->
    <div class="marketplace-controls">
        <div class="container">
            <div class="search-bar">
                <i class="fas fa-search"></i>
                <input type="text" id="search-input" placeholder="Search extensions...">
            </div>
            <div class="filter-controls">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="installed">Installed</button>
                <button class="filter-btn" data-filter="free">Free</button>
                <button class="filter-btn" data-filter="premium">Premium</button>
                <button class="filter-btn" data-filter="recorder">Recorder</button>
                <button class="filter-btn" data-filter="visualization">Visualization</button>
            </div>
        </div>
    </div>

    <!-- Extensions Grid -->
    <div class="container">
        <div class="extensions-grid" id="extensions-container">
            <!-- Extensions will be dynamically loaded here -->
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-grid">
                <div class="footer-col">
                    <div class="logo">
                        <img src="assets/logo.png" alt="Plotune Logo" style="height: 36px;">
                        <h1 style="font-size: 1.5rem;">Plotune</h1>
                    </div>
                    <p style="margin-top: 20px; color: var(--gray-text); max-width: 300px;">
                        Empowering engineers, analysts, and researchers with real-time data visualization tools.
                    </p>
                </div>
                <div class="footer-col">
                    <h3>Product</h3>
                    <ul class="footer-links">
                        <li><a href="index.html">Features</a></li>
                        <li><a href="extensions.html">Extensions</a></li>
                        <li><a href="download.html">Download</a></li>
                        <li><a href="pricing.html">Pricing</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h3>Resources</h3>
                    <ul class="footer-links">
                        <li><a href="docs.html">Documentation</a></li>
                        <li><a href="tutorials.html">Tutorials</a></li>
                        <li><a href="blog.html">Blog</a></li>
                        <li><a href="community.html">Community</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h3>Company</h3>
                    <ul class="footer-links">
                        <li><a href="about.html">About Us</a></li>
                        <li><a href="contact.html">Contact</a></li>
                        <li><a href="careers.html">Careers</a></li>
                        <li><a href="legal.html">Legal</a></li>
                    </ul>
                </div>
            </div>
            <div class="copyright">
                &copy; 2023 Plotune. All rights reserved.
            </div>
        </div>
    </footer>

    <script src="api_extension.js"></script>
    <script src="software_watcher.js"></script>
    
    <script>
        // DOM Elements
        const extensionsContainer = document.getElementById('extensions-container');
        const searchInput = document.getElementById('search-input');
        const filterButtons = document.querySelectorAll('.filter-btn');
        
        // Current filter state
        let currentFilter = 'all';
        let currentSearch = '';
        
        // Function to render extension cards
        function renderExtensions(extensions) {
            extensionsContainer.innerHTML = '';
            
            extensions.forEach(extension => {
                // Skip if doesn't match filter
                if (!matchesFilter(extension)) return;
                
                const card = document.createElement('div');
                card.className = 'extension-card';
                
                // Create tags based on extension properties
                let tagsHTML = '';
                if (extension.mode === 'hybrid') {
                    tagsHTML += '<span class="extension-tag tag-special">Hybrid</span>';
                }
                if (extension.category === 'Recorder') {
                    tagsHTML += '<span class="extension-tag tag-lite">Lite</span>';
                } else if (extension.category === 'Visualization') {
                    tagsHTML += '<span class="extension-tag tag-pro">Pro</span>';
                }
                
                // Create action buttons based on state and connection
                let actionsHTML = '';
                if (backendUrl && extension.installed) {
                    actionsHTML += `
                        <button class="btn btn-toggle" data-id="${extension.id}">
                            <i class="fas fa-power-off"></i> ${extension.enabled ? 'Disable' : 'Enable'}
                        </button>
                    `;
                } else {
                    actionsHTML += `
                        <button class="btn btn-install" data-id="${extension.id}">
                            <i class="fas fa-download"></i> Install
                        </button>
                    `;
                    
                    if (extension.category === 'Visualization') {
                        actionsHTML += `
                            <button class="btn btn-buy" data-id="${extension.id}">
                                <i class="fas fa-shopping-cart"></i> Buy ($5)
                            </button>
                        `;
                    }
                }
                
                actionsHTML += `
                    <button class="btn btn-website" data-id="${extension.id}" data-url="${extension.git_path}">
                        <i class="fas fa-external-link-alt"></i> Website
                    </button>
                `;
                
                card.innerHTML = `
                    <div class="extension-header">
                        <div class="extension-tags">
                            ${tagsHTML}
                        </div>
                        <div class="extension-title">
                            <h3>${extension.name}</h3>
                            <span class="extension-version">v${extension.version}</span>
                        </div>
                        <div class="extension-author">by ${extension.author}</div>
                        <div class="extension-description">${extension.description}</div>
                        <div class="extension-meta">
                            <span>${extension.category}</span>
                            <span>Updated: ${formatDate(extension.last_updated)}</span>
                        </div>
                    </div>
                    <div class="extension-body">
                        <ul class="extension-features">
                            <li><i class="fas fa-check-circle"></i> ${extension.file_formats.length} file formats supported</li>
                            <li><i class="fas fa-plug"></i> ${extension.mode} mode</li>
                            <li><i class="fas fa-server"></i> Runs on ${extension.os}</li>
                        </ul>
                        <div class="extension-actions">
                            ${actionsHTML}
                        </div>
                    </div>
                `;
                
                extensionsContainer.appendChild(card);
            });
            
            // Add event listeners to action buttons
            if (backendUrl) {
                document.querySelectorAll('.btn-toggle').forEach(btn => {
                    btn.addEventListener('click', toggleExtension);
                });
            }
            document.querySelectorAll('.btn-install').forEach(btn => {
                btn.addEventListener('click', installExtension);
            });
            document.querySelectorAll('.btn-buy').forEach(btn => {
                btn.addEventListener('click', buyExtension);
            });
            document.querySelectorAll('.btn-website').forEach(btn => {
                btn.addEventListener('click', visitWebsite);
            });
        }
        
        // Filter matching function
        function matchesFilter(extension) {
            // Search filter
            if (currentSearch && 
                !extension.name.toLowerCase().includes(currentSearch) && 
                !extension.description.toLowerCase().includes(currentSearch) &&
                !extension.category.toLowerCase().includes(currentSearch)) {
                return false;
            }
            
            // Category filters (disable 'installed' filter if no backend)
            if (!backendUrl && currentFilter === 'installed') {
                return false; // No installed extensions without backend
            }
            switch(currentFilter) {
                case 'installed':
                    return extension.installed;
                case 'free':
                    return extension.category === 'Recorder';
                case 'premium':
                    return extension.category === 'Visualization';
                case 'recorder':
                    return extension.category === 'Recorder';
                case 'visualization':
                    return extension.category === 'Visualization';
                default:
                    return true;
            }
        }
        
        // Format date for display
        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }
        
        // Fetch and merge extensions
        async function fetchAndMergeExtensions() {
            if (!backendUrl) {
                console.log('No backend connection; showing all extensions as not installed.');
                return extensionsData.map(ext => ({
                    ...ext,
                    installed: false,
                    enabled: false
                }));
            }

            console.log('Fetching extensions status from backend...');
            try {
                const response = await fetch(`${backendUrl}/api/extensions`);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const localExtensions = await response.json();
                console.log('Extensions status fetched:', localExtensions);

                // Merge by id
                return extensionsData.map(ext => {
                    const local = localExtensions.find(le => le.id === ext.id);
                    return {
                        ...ext,
                        installed: local ? local.installed : false,
                        enabled: local ? local.enabled : false,
                        version: local ? local.version : ext.version
                    };
                });
            } catch (err) {
                console.error('Failed to fetch/merge extensions:', err.message, err.stack);
                showNotification('Error fetching extension status. Showing catalog.');
                return extensionsData.map(ext => ({
                    ...ext,
                    installed: false,
                    enabled: false
                }));
            }
        }
        
        // Toggle extension (only in connected mode)
        async function toggleExtension(e) {
            if (!backendUrl) return; // Shouldn't be called without backend

            const id = e.target.dataset.id;
            const extension = extensionsData.find(ext => ext.id === id);
            
            if (extension) {
                const newEnabled = !extension.enabled;
                console.log('Toggling extension:', id, 'to', newEnabled ? 'enabled' : 'disabled');
                
                try {
                    const endpoint = newEnabled ? `/api/start/${id}` : `/api/disable/${id}`;
                    const response = await fetch(`${backendUrl}${endpoint}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    const data = await response.json();
                    if (data.status) {
                        extension.enabled = newEnabled;
                        showNotification(`Extension ${newEnabled ? 'enabled' : 'disabled'}: ${extension.name}`);
                    } else {
                        throw new Error('Backend operation failed');
                    }
                } catch (err) {
                    console.error('Toggle failed:', err.message, err.stack);
                    showNotification(`Error toggling ${extension.name}. Please try again.`);
                    return;
                }
                
                // Refresh and re-render
                const updatedData = await fetchAndMergeExtensions();
                renderExtensions(updatedData);
            }
        }
        
        // Install extension
        async function installExtension(e) {
            const id = e.target.dataset.id;
            const extension = extensionsData.find(ext => ext.id === id);
            
            if (extension) {
                console.log('Install clicked for extension:', id);
                
                if (!backendUrl) {
                    // Visitor mode: redirect to download page
                    showNotification(`Redirecting to download page for ${extension.name}`);
                    window.location.href = 'download.html';
                    return;
                }
                
                // Connected mode: call API
                try {
                    const response = await fetch(`${backendUrl}/api/install/${id}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({})
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    extension.installed = true;
                    extension.enabled = true;
                    showNotification(`Extension installed: ${extension.name}`);
                } catch (err) {
                    console.error('Install failed:', err.message, err.stack);
                    showNotification(`Error installing ${extension.name}. ${err.message.includes('NotImplementedError') ? 'Install not yet supported on backend.' : 'Please try again.'}`);
                    return;
                }
                
                // Refresh and re-render
                const updatedData = await fetchAndMergeExtensions();
                renderExtensions(updatedData);
            }
        }
        
        // Buy extension
        function buyExtension(e) {
            const id = e.target.dataset.id;
            const extension = extensionsData.find(ext => ext.id === id);
            
            if (extension) {
                console.log('Buying extension:', id);
                showNotification(`Redirecting to purchase: ${extension.name}`);
                setTimeout(() => {
                    alert(`Would redirect to purchase page for ${extension.name}`);
                }, 500);
            }
        }
        
        // Visit website
        function visitWebsite(e) {
            const url = e.target.dataset.url;
            if (url) {
                console.log('Opening website:', url);
                showNotification(`Opening extension website in new tab`);
                window.open(url, '_blank');
            } else {
                console.warn('No URL for extension:', e.target.dataset.id);
                showNotification('Error: No website available for this extension.');
            }
        }
        
        // Show notification
        function showNotification(message) {
            console.log(`Notification: ${message}`);
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            // Filter button event listeners
            filterButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    filterButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.dataset.filter;
                    renderExtensions(extensionsData);
                });
            });
            
            // Search input event listener
            searchInput.addEventListener('input', function() {
                currentSearch = this.value.toLowerCase();
                renderExtensions(extensionsData);
            });
            
            // Mobile menu toggle
            document.querySelector('.mobile-menu-btn').addEventListener('click', function() {
                const nav = document.querySelector('nav ul');
                nav.style.display = nav.style.display === 'flex' ? 'none' : 'flex';
            });
            
            // Load and render
            extensionsContainer.innerHTML = '<div class="loading">Loading extensions...</div>';
            const updatedData = await fetchAndMergeExtensions();
            renderExtensions(updatedData);
        });
    </script>
</body>
</html>